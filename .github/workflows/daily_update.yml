name: API Update & Deploy

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. Mise à jour vers checkout@v4
      - name: Checkout du code
        uses: actions/checkout@v4

      # 2. Mise à jour vers setup-python@v5
      - name: Installation Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Installation des dépendances
        run: pip install requests

      - name: Lancement du script Python
        run: python export_tv.py
      
      - name: Préparation des fichiers du site
        run: |
          mkdir public
          cp programme_tv.json public/
          echo "<h1>API TV Active</h1><p><a href='programme_tv.json'>Voir le JSON</a></p>" > public/index.html

      # 3. CRITIQUE : Passage à upload-pages-artifact@v3 (qui utilise le nouveau moteur v4)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      # 4. CRITIQUE : Passage à deploy-pages@v4
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
